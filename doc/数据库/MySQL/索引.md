## 索引

### 1. 索引基础

索引是数据库高效获取数据的数据结构，加快查询速度，索引一般存储在表空间中，就是磁盘上。

常见索引：聚簇索引，辅助索引，组合索引，唯一性索引。

#### 1.1 索引优势

- 可以提高数据检索效率，降低数据库IO成本。
- 通过索引列对数据进行排序，降低数据排序的成本，降低CPU的消耗
  - 被索引的列会自动进行排序，B+树叶子节点的有序特性。
  - 如果Order By的字段使用索引，效率会高很多。

#### 1.2 劣势

- 占用更多的磁盘空间，空间换时间。
- 提高了查询效率，但是降低更新效率。

### 2. 使用索引

#### 2.1 索引类型

##### 2.1.1 单列索引

索引中只有一个列

- 主键索引：必须唯一，非空

  ```mysql
  alter table table_name add primary key(column_name);
  ```

- 唯一性索引：必须唯一，可以为空

  ```mysql
  create unique index index_name on table(column_name);
  ```

- 普通索引：可以不唯一，可以为空

  ```mysql
  alter table table_name add index index_name(column_name);
  ```

- 全文索引：支持全文搜索的索引，只能对文本类型字段设置，不建议使用

##### 2.1.2 组合索引

组合索引的使用，需要遵循最左匹配原则。

一般情况下，建议使用组合索引代替单列索引。

```mysql
alter table table_name add index index_name (column1,column2);  
```

#### 2.2 删除索引

```mysql
drop index index_name on table
```

#### 2.3 查看索引

```mysql
show index from table_name
```

### 3. 索引数据结构

#### 3.1 Hash表

Hash表可以key存储索引列，value可以存储行记录，查询效率很高，时间复杂度O(1)。

不支持范围快速查找，范围查找只能全表扫描。数据结构比较稀疏，不适合做聚合，不适合做范围等查找。

#### 3.2 二叉查找树

二叉树特点：每个节点最多有2个分叉，左子树和右子树数据顺序左小右大。不是平衡的。

二叉树的检索复杂度和树高相关：理想状态下效率可以到O(logn)。

极端情况下，二叉查找树会构建成单向列表，即全表扫描。

#### 3.3 红黑树

红黑树是一个近似平衡的二叉树。平衡二叉树是采用二分法思维，具备了二叉树的特点，最主要的特征是树的左右两个子树的层级最多差1。插入删除数据时通过左旋/右旋操作保持二叉树的平衡。

平衡二叉树存在的问题：

- 时间复杂度和树高相关：树有多高就需要检索多少次，每个节点的读取，都对应一次磁盘IO操作。
- 平衡二叉树不支持范围查找，范围查找需要从根节点多次遍历，查询效率极差。
- 数据量大的情况下，索引存储空间占用极大。

#### 3.4 B树

B树，改进二叉树，多叉树。要减少IO操作，就要尽量降低树高。每个节点存储多个元素。二叉树改造成多叉树，将树高瘦变成矮胖。

主要特点：

- B树的节点中存储多个元素，每个节点内多个分叉。
- 节点中的元素包含键值和数据，节点中的键值从大到小排列，所有的节点都存储数据。
- 父节点中的元素不会出现在子节点中。
- 所有的叶子节点都位于同一层，叶节点具有相同的深度，叶节点之间没有指针连接。

![B-Tree](https://gitee.com/lusanjun/blog-img/raw/master/B-Tree.png)

优点：

- 磁盘IO次数大大减少
- 比较是在内存中进行，比较的耗时可以忽略不计
- B树的高度相比于平衡二叉树会大幅减少，所以用B树可以很好提升查询效率。

缺点：

- B树不支持范围查询的快速查找
- 空间占用较大

#### 3.5 B+树

B+树和B树最主要的区别在于非叶子节点是否存储数据

- B树：非叶子节点和叶子节点都会存储数据
- B+树：只有叶子节点才会存储数据，非叶子节点只存储键值。叶子节点之间使用双向指针连接，最底层的叶子节点形成一个双向有序链表。

![B+Tree](https://gitee.com/lusanjun/blog-img/raw/master/B+-Tree.png)

优点：

- 继承了B树的优点
- 保证等值和范围查询的快速查找
- MySQL的索引采用了B+树的结构

### 4.  存储引擎的索引

#### 4.1 MyISAM

MyISAM的数据文件和索引文件是分开存储的，MyISAM使用B+树构建索引树，叶子节点中存储的键值为索引列的值，数据为索引所在行的磁盘地址。

- 主键索引：

##### 4.1.1 等值查询

```mysql
select * from user where id = 1;
```

- 先在主键树中从根节点开始检索，将根节点加载到内存

### 5. InnoDB索引

每个InnoDB表都有一个聚簇索引，也叫聚集索引。除了聚簇索引外的其他索引都叫辅助索引。

聚簇索引是B+Tree数据结构，叶子节点存储数据行，非叶子节点存储主键值。

InnoDB创建索引规则：

- 在表上定义主键 Primary Key，InnoDB将主键索引用作聚簇索引。
- 如果表没有定义主键，InnoDB会选择第一个不为Null的唯一索引列用作聚簇索引。
- 如果以上两个都没有，InnoDB会使用一个6字节长整型的隐式字段Rowid字段构建聚簇索引。该字段会在插入新行时自动递增。

#### 5.1 主键索引

主键索引的叶子节点会存储数据行，辅助索引只会存储主键值。

InnoDB要求表必须有一个主键索引。

